{% extends "base.html" %}

{% block title %}New AOI Report · AOI Reporting{% endblock %}

{% block content %}
  <div class="row mb-4">
    <div class="col-lg-8">
      <h1 class="h3">Log New AOI Report</h1>
      <p class="text-muted">Provide inspection details and record any defects identified.</p>
    </div>
    <div class="col-lg-4 text-lg-end">
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard') }}">Back to Dashboard</a>
    </div>
  </div>

  <form method="post" novalidate>
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <strong>Job &amp; Assembly</strong>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label" for="job_number">Job Number<span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="text"
            id="job_number"
            name="job_number"
            required
            value="{{ form_data.get('job_number', '') }}"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="assembly_number">Assembly Number<span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="text"
            id="assembly_number"
            name="assembly_number"
            required
            value="{{ form_data.get('assembly_number', '') }}"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="revision_code">Revision Code</label>
          <input
            class="form-control"
            type="text"
            id="revision_code"
            name="revision_code"
            value="{{ form_data.get('revision_code', '') }}"
          />
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <strong>Operation Details</strong>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label" for="operation_name">Operation<span class="text-danger">*</span></label>
          <select class="form-select" id="operation_name" name="operation_name" required>
            <option value="">Select operation…</option>
            {% for operation in operations %}
              <option value="{{ operation.name }}" {% if form_data.get('operation_name') == operation.name %}selected{% endif %}>
                {{ operation.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="line_name">Line<span class="text-danger">*</span></label>
          <select class="form-select" id="line_name" name="line_name" required>
            <option value="">Select line…</option>
            {% for line in lines %}
              <option value="{{ line.name }}" {% if form_data.get('line_name') == line.name %}selected{% endif %}>
                {{ line.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label" for="operator_badge">Operator Badge</label>
          <input
            class="form-control"
            type="text"
            id="operator_badge"
            name="operator_badge"
            value="{{ form_data.get('operator_badge', '') }}"
            placeholder="Optional"
          />
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <strong>Inspection Results</strong>
      </div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label" for="boards_inspected">Boards Inspected<span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="number"
            id="boards_inspected"
            name="boards_inspected"
            min="0"
            required
            value="{{ form_data.get('boards_inspected', '') }}"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="boards_ng">Boards NG<span class="text-danger">*</span></label>
          <input
            class="form-control"
            type="number"
            id="boards_ng"
            name="boards_ng"
            min="0"
            required
            value="{{ form_data.get('boards_ng', '') }}"
          />
        </div>
        <div class="col-md-4">
          <label class="form-label" for="notes">Notes</label>
          <textarea class="form-control" id="notes" name="notes" rows="1" placeholder="Optional">{{ form_data.get('notes', '') }}</textarea>
        </div>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>Defects</strong>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-defect-row">Add Row</button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle" id="defect-table">
            <thead>
              <tr>
                <th scope="col" style="width: 45%">Defect Code</th>
                <th scope="col" style="width: 45%">Count</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="defect-rows">
              {% for row in defect_rows %}
                <tr>
                  <td>
                    <select class="form-select" name="defect_code">
                      <option value="">Select defect…</option>
                      {% for code in defect_codes %}
                        <option value="{{ code.code }}" {% if row.code == code.code %}selected{% endif %}>
                          {{ code.code }} – {{ code.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>
                  <td>
                    <input
                      class="form-control"
                      type="number"
                      min="0"
                      name="defect_count"
                      value="{{ row.count }}"
                    />
                  </td>
                  <td class="text-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-defect-row">Remove</button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="text-muted small mb-0">Leave all rows blank if no defects were observed.</p>
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-success btn-lg">Submit AOI Report</button>
    </div>
  </form>

  <template id="defect-row-template">
    <tr>
      <td>
        <select class="form-select" name="defect_code">
          <option value="">Select defect…</option>
          {% for code in defect_codes %}
            <option value="{{ code.code }}">{{ code.code }} – {{ code.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td>
        <input class="form-control" type="number" min="0" name="defect_count" />
      </td>
      <td class="text-end">
        <button type="button" class="btn btn-outline-danger btn-sm remove-defect-row">Remove</button>
      </td>
    </tr>
  </template>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const tableBody = document.getElementById('defect-rows');
      const template = document.getElementById('defect-row-template');
      const addBtn = document.getElementById('add-defect-row');

      addBtn?.addEventListener('click', () => {
        const clone = template.content.cloneNode(true);
        tableBody.appendChild(clone);
      });

      tableBody?.addEventListener('click', (event) => {
        if (event.target instanceof HTMLElement && event.target.classList.contains('remove-defect-row')) {
          const row = event.target.closest('tr');
          if (row && tableBody.rows.length > 1) {
            row.remove();
          }
        }
      });
    });
  </script>
{% endblock %}
