{% extends "base.html" %}
{% block title %}AOI Inspection Data Sheet{% endblock %}
{% block body_class %}layout-flow{% endblock %}
{% block container_class %}container--fluid{% endblock %}
{% block styles %}
  {{ super() }}
  :root {
    --sheet-width: 8.5in;
    --sheet-height: 11in;
    --sheet-border: #0f172a;
    --sheet-muted: #475569;
    --sheet-label: #111827;
    --sheet-accent: #1d4ed8;
    --sheet-background: #ffffff;
    --sheet-line: 1.5px solid var(--sheet-border);
  }

  body.layout-flow {
    align-items: stretch;
  }

  .aoi-wrapper {
    display: flex;
    justify-content: center;
    padding: 1rem 0 2rem;
    width: 100%;
    overflow-x: auto;
  }

  #aoi-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.25rem;
    width: 100%;
  }

  .aoi-sheet {
    width: var(--sheet-width);
    max-width: calc(100% - 2rem);
    min-height: var(--sheet-height);
    background: var(--sheet-background);
    border: 2px solid var(--sheet-border);
    box-shadow: 0 28px 60px rgba(15, 23, 42, 0.25);
    padding: 0.42in 0.46in;
    display: grid;
    grid-template-columns: minmax(0, 6.05in) minmax(0, 1.6in);
    column-gap: 0.3in;
    color: var(--sheet-label);
  }

  .sheet-main {
    display: grid;
    row-gap: 0.32in;
  }

  .sheet-header {
    border: var(--sheet-line);
    padding: 0.22in 0.26in 0.18in;
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    grid-auto-rows: auto;
    column-gap: 0.22in;
    row-gap: 0.14in;
    align-items: end;
  }

  .sheet-title {
    grid-column: 1 / span 7;
    font-size: 1.02rem;
    text-transform: uppercase;
    letter-spacing: 0.24em;
    margin: 0;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.05in;
    font-size: 0.6rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--sheet-muted);
  }

  .field label,
  .field legend {
    font-weight: 600;
  }

  .field .field-static,
  .field .field-control {
    font-family: inherit;
    font-size: 0.84rem;
    letter-spacing: 0.02em;
    text-transform: none;
    color: var(--sheet-label);
    padding: 0.04in 0;
    border: none;
    border-bottom: var(--sheet-line);
    background: transparent;
  }

  .field .field-static {
    min-height: 0.34in;
    display: flex;
    align-items: flex-end;
  }

  .field .field-control:focus,
  .field .field-control:focus-visible {
    outline: 2px solid rgba(29, 78, 216, 0.45);
    outline-offset: 2px;
  }

  .field select.field-control {
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, var(--sheet-border) 50%),
      linear-gradient(135deg, var(--sheet-border) 50%, transparent 50%);
    background-position: calc(100% - 12px) calc(50% - 3px), calc(100% - 7px) calc(50% - 3px);
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
    padding-right: 1.4rem;
  }

  .field input[type="number"].field-control {
    -moz-appearance: textfield;
  }

  .field input[type="number"].field-control::-webkit-outer-spin-button,
  .field input[type="number"].field-control::-webkit-inner-spin-button {
    margin: 0;
    -webkit-appearance: none;
  }

  .field--form-number {
    grid-column: 8 / span 2;
    grid-row: 1;
  }

  .field--form-rev {
    grid-column: 10 / span 3;
    grid-row: 1;
  }

  .field--date {
    grid-column: 1 / span 3;
    grid-row: 2;
  }

  fieldset.field.field--type {
    grid-column: 4 / span 6;
    grid-row: 2;
    border: none;
    padding: 0;
    margin: 0;
  }

  .field--type legend {
    padding: 0;
  }

  .field--type .options {
    display: inline-flex;
    gap: 0.4in;
    font-size: 0.8rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--sheet-label);
  }

  .field--type .options label {
    display: inline-flex;
    align-items: center;
    gap: 0.12in;
    font-weight: 500;
  }

  .field--type input[type="radio"] {
    width: 0.22in;
    height: 0.22in;
  }

  .section {
    border: var(--sheet-line);
    padding: 0.22in 0.26in;
    background: var(--sheet-background);
  }

  .section-title {
    margin: 0 0 0.16in;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .section-body {
    display: grid;
    column-gap: 0.22in;
    row-gap: 0.2in;
  }

  .section-body.job {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }

  .section-body.job .field--customer {
    grid-column: 1 / span 2;
  }

  .section-body.job .field--assembly {
    grid-column: 3 / span 2;
  }

  .section-body.job .field--job-number {
    grid-column: 1 / span 2;
  }

  .section-body.job .field--revision {
    grid-column: 3 / span 1;
  }

  .section-body.job .field--inspector {
    grid-column: 4 / span 1;
  }

  .section-body.job .field--panels {
    grid-column: 1 / span 1;
  }

  .section-body.job .field--boards {
    grid-column: 2 / span 1;
  }

  .section-body.lot {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }

  .lot-feedback {
    margin-top: 0.1in;
    font-size: 0.7rem;
    letter-spacing: 0.04em;
    color: #b91c1c;
    min-height: 0.3in;
  }

  .rejection-feedback {
    margin-top: 0.18in;
    font-size: 0.7rem;
    letter-spacing: 0.04em;
    color: var(--sheet-muted);
    min-height: 0.3in;
  }

  .aoi-rejection-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.78rem;
  }

  .aoi-rejection-table thead th {
    font-size: 0.64rem;
    letter-spacing: 0.18em;
    text-transform: uppercase;
  }

  .aoi-rejection-table th,
  .aoi-rejection-table td {
    border: var(--sheet-line);
    padding: 0.14in 0.1in;
    vertical-align: top;
  }

  .aoi-rejection-table input,
  .aoi-rejection-table select {
    width: 100%;
    border: none;
    border-bottom: 1px solid var(--sheet-border);
    background: transparent;
    font-size: 0.78rem;
    font-family: inherit;
    padding: 0.02in 0;
  }

  .aoi-rejection-table input:focus,
  .aoi-rejection-table select:focus {
    outline: 2px solid rgba(29, 78, 216, 0.45);
    outline-offset: 2px;
  }

  .aoi-rejection-table__actions {
    display: flex;
    justify-content: center;
  }

  .aoi-rejection-table__actions .aoi-delete-row {
    border: none;
    background: rgba(15, 23, 42, 0.08);
    padding: 0.1in 0.18in;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.62rem;
    cursor: pointer;
  }

  .aoi-table-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.18in;
    margin-top: 0.18in;
  }

  .aoi-table-footer button {
    border: none;
    background: var(--sheet-border);
    color: #ffffff;
    padding: 0.12in 0.26in;
    font-size: 0.64rem;
    letter-spacing: 0.16em;
    text-transform: uppercase;
    cursor: pointer;
  }

  details.aoi-board-details {
    border: var(--sheet-line);
    padding: 0.22in 0.26in;
    background: rgba(241, 245, 249, 0.35);
  }

  details.aoi-board-details[open] {
    background: rgba(241, 245, 249, 0.65);
  }

  details.aoi-board-details summary {
    cursor: pointer;
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 0.18in;
  }

  .aoi-board-grid {
    display: grid;
    gap: 0.2in;
  }

  .aoi-board-row {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr)) auto;
    gap: 0.2in;
    align-items: end;
  }

  .aoi-board-row .field {
    gap: 0.04in;
  }

  .aoi-comments {
    border: var(--sheet-line);
    padding: 0.22in 0.26in;
  }

  .aoi-comments textarea {
    width: 100%;
    min-height: 2.2in;
    border: none;
    background: repeating-linear-gradient(
      transparent,
      transparent 0.28in,
      rgba(15, 23, 42, 0.12) 0.28in,
      rgba(15, 23, 42, 0.12) 0.29in
    );
    padding: 0.08in;
    font-size: 0.85rem;
    font-family: inherit;
    line-height: 1.6;
  }

  .aoi-comments textarea:focus {
    outline: 2px solid rgba(29, 78, 216, 0.45);
    outline-offset: 2px;
  }

  .aoi-problem-panel {
    border: var(--sheet-line);
    padding: 0.22in 0.2in;
    background: rgba(248, 250, 252, 0.8);
    display: flex;
    flex-direction: column;
    gap: 0.18in;
  }

  .aoi-problem-panel h2 {
    margin: 0;
    font-size: 0.72rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }

  .aoi-problem-codes__label {
    font-weight: 400;
    letter-spacing: 0.08em;
  }

  .aoi-problem-codes {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.12in;
    font-size: 0.68rem;
  }

  .aoi-problem-codes button {
    border: none;
    background: transparent;
    text-align: left;
    padding: 0.06in 0.04in;
    font-size: 0.68rem;
    letter-spacing: 0.08em;
    cursor: pointer;
  }

  .aoi-problem-codes button:hover,
  .aoi-problem-codes button:focus {
    background: rgba(29, 78, 216, 0.12);
    outline: none;
  }

  .aoi-problem-codes strong {
    font-size: 0.7rem;
    letter-spacing: 0.16em;
  }

  .aoi-footer-actions {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-end;
    gap: 0.75rem;
    width: min(var(--sheet-width), calc(100% - 2rem));
  }

  .aoi-footer-actions button {
    padding: 0.75rem 1.4rem;
    border: none;
    background: var(--sheet-border);
    color: #ffffff;
    font-size: 0.86rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
  }

  .aoi-footer-actions button[data-action="draft"] {
    background: #475569;
  }

  .aoi-footer-actions button[data-action="print"] {
    background: #1e3a8a;
  }

  .aoi-inline-feedback {
    width: min(var(--sheet-width), calc(100% - 2rem));
    font-size: 0.82rem;
    color: #14532d;
    min-height: 1.2rem;
  }

  @media (max-width: 1100px) {
    .aoi-sheet {
      transform: scale(0.9);
      transform-origin: top center;
    }

    .aoi-footer-actions,
    .aoi-inline-feedback {
      transform: scale(0.9);
      transform-origin: top center;
    }
  }

  @media (max-width: 900px) {
    .aoi-sheet {
      transform: scale(0.8);
    }

    .aoi-footer-actions,
    .aoi-inline-feedback {
      transform: scale(0.8);
    }
  }
{% endblock %}
{% block content %}
  <div class="aoi-wrapper" data-problem-codes='{{ problem_codes|tojson }}'>
    <form id="aoi-form" novalidate>
      <input type="hidden" name="form_number" value="Form-114" />
      <input type="hidden" name="form_rev" value="Rev. 17 (9/9/2025)" />
      <div class="aoi-sheet">
        <section class="sheet-main">
          <header class="sheet-header">
            <h1 class="sheet-title">AOI Inspection Data Sheet</h1>
            <div class="field field--form-number">
              <label>Form #</label>
              <div class="field-static">Form-114</div>
            </div>
            <div class="field field--form-rev">
              <label>Form Rev</label>
              <div class="field-static">Rev. 17 (9/9/2025)</div>
            </div>
            <div class="field field--date">
              <label for="aoi-date">Date</label>
              <input id="aoi-date" name="date" type="date" class="field-control" value="{{ today.isoformat() }}" required />
            </div>
            <fieldset class="field field--type">
              <legend>Type</legend>
              <div class="options">
                <label><input type="radio" name="type" value="SMT" required /> SMT</label>
                <label><input type="radio" name="type" value="TH" /> TH</label>
              </div>
            </fieldset>
          </header>

          <section class="section section--job">
            <h2 class="section-title">Job Identifiers</h2>
            <div class="section-body job">
              <div class="field field--customer">
                <label for="job-customer">Customer</label>
                <input id="job-customer" name="customer" type="text" class="field-control" />
              </div>
              <div class="field field--assembly">
                <label for="job-assembly">Assembly</label>
                <input id="job-assembly" name="assembly" type="text" class="field-control" />
              </div>
              <div class="field field--job-number">
                <label for="job-number">Job #</label>
                <input id="job-number" name="job_number" type="text" class="field-control" />
              </div>
              <div class="field field--revision">
                <label for="job-revision">Revision</label>
                <input id="job-revision" name="revision" type="text" class="field-control" />
              </div>
              <div class="field field--panels">
                <label for="job-panels"># of Panels</label>
                <input id="job-panels" name="panels_count" type="number" min="0" value="0" class="field-control" />
              </div>
              <div class="field field--boards">
                <label for="job-boards"># of Boards</label>
                <input id="job-boards" name="boards_count" type="number" min="0" value="0" class="field-control" />
              </div>
              <div class="field field--inspector">
                <label for="job-inspector">Inspector</label>
                <select id="job-inspector" name="inspector" class="field-control">
                  <option value="">Select inspector</option>
                  {% for inspector in inspectors %}
                    <option value="{{ inspector }}">{{ inspector }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </section>

          <section class="section section--lot">
            <h2 class="section-title">Lot Inspection Result</h2>
            <div class="section-body lot">
              <div class="field">
                <label for="lot-inspected">Quantity Inspected</label>
                <input id="lot-inspected" name="qty_inspected" type="number" min="0" value="0" class="field-control" />
              </div>
              <div class="field">
                <label for="lot-rejected">Quantity Rejected</label>
                <input id="lot-rejected" name="qty_rejected" type="number" min="0" value="0" class="field-control" />
              </div>
              <div class="field">
                <label for="lot-accepted">Quantity Accepted</label>
                <input id="lot-accepted" name="qty_accepted" type="number" readonly value="0" class="field-control" />
              </div>
            </div>
            <p class="lot-feedback" id="lot-feedback" role="status"></p>
          </section>

          <section class="section section--rejections">
            <h2 class="section-title">Reason for Rejection</h2>
            <table class="aoi-rejection-table" aria-describedby="rejection-help">
              <thead>
                <tr>
                  <th scope="col">Quantity</th>
                  <th scope="col">Problem Code</th>
                  <th scope="col">Defective Problem</th>
                  <th scope="col">Reference Designator(s)</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody id="rejection-rows"></tbody>
            </table>
            <div class="aoi-table-footer">
              <button type="button" id="add-rejection">Add Row</button>
            </div>
            <p id="rejection-help" class="rejection-feedback" aria-live="polite"></p>
          </section>

          <details class="aoi-board-details">
            <summary>Board Data (optional detail)</summary>
            <div class="aoi-board-grid" id="board-rows"></div>
            <div class="aoi-table-footer">
              <button type="button" id="add-board">Add Board Entry</button>
            </div>
          </details>

          <section class="aoi-comments">
            <div class="field">
              <label for="aoi-comments">Comments</label>
              <textarea id="aoi-comments" name="comments"></textarea>
            </div>
          </section>
        </section>

        <aside class="aoi-problem-panel" aria-label="Problem Codes Reference">
          <h2>Problem Codes</h2>
          <ul class="aoi-problem-codes">
            {% for entry in problem_codes %}
              <li>
                <button
                  type="button"
                  data-problem-code="{{ entry.code }}"
                  title="{{ entry.name }}{% if entry.part_type %} • {{ entry.part_type }}{% endif %}"
                >
                  <strong>{{ entry.code }}</strong>
                  <span class="aoi-problem-codes__label">— {{ entry.name }}{% if entry.part_type %} · {{ entry.part_type }}{% endif %}</span>
                </button>
              </li>
            {% endfor %}
          </ul>
        </aside>
      </div>

      <div class="aoi-footer-actions">
        <button type="button" data-action="draft">Save Draft</button>
        <button type="button" data-action="submit">Submit</button>
        <button type="button" data-action="print" disabled>Print / Export PDF</button>
      </div>
      <div class="aoi-inline-feedback" id="form-feedback" aria-live="polite"></div>
    </form>
  </div>

  <template id="rejection-row-template">
    <tr>
      <td>
        <input type="number" min="1" value="1" class="aoi-rejection-quantity" />
      </td>
      <td>
        <select class="aoi-rejection-code">
          <option value="" title="Select a problem code">Select</option>
          {% for entry in problem_codes %}
            <option
              value="{{ entry.code }}"
              title="{{ entry.name }}{% if entry.part_type %} • {{ entry.part_type }}{% endif %}"
            >
              {{ entry.code }}
            </option>
          {% endfor %}
        </select>
      </td>
      <td class="aoi-rejection-name" data-placeholder="Select a code"></td>
      <td>
        <input type="text" class="aoi-rejection-refdes" placeholder="R12, C33" />
      </td>
      <td class="aoi-rejection-table__actions">
        <button type="button" class="aoi-delete-row">Delete</button>
      </td>
    </tr>
  </template>

  <template id="board-row-template">
    <div class="aoi-board-row">
      <div class="field">
        <label>Board ID / Serial</label>
        <input type="text" class="aoi-board-id field-control" />
      </div>
      <div class="field">
        <label>Reference Designator(s)</label>
        <input type="text" class="aoi-board-refdes field-control" />
      </div>
      <div class="field">
        <label>Problem Code</label>
        <select class="aoi-board-code field-control">
          <option value="" title="Select a problem code">Select</option>
          {% for entry in problem_codes %}
            <option
              value="{{ entry.code }}"
              title="{{ entry.name }}{% if entry.part_type %} • {{ entry.part_type }}{% endif %}"
            >
              {{ entry.code }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Comments</label>
        <input type="text" class="aoi-board-comments field-control" />
      </div>
      <div class="aoi-rejection-table__actions">
        <button type="button" class="aoi-delete-row">Delete</button>
      </div>
    </div>
  </template>

  <script>
    const wrapper = document.querySelector('.aoi-wrapper');
    const rawProblemCodes = wrapper ? JSON.parse(wrapper.dataset.problemCodes) : [];
    const PROBLEM_CODES = new Map(
      rawProblemCodes.map((entry) => [
        String(entry.code),
        {
          name: entry.name,
          partType: entry.part_type || '',
        },
      ]),
    );

    function formatProblemDetails(code) {
      const info = PROBLEM_CODES.get(String(code));
      if (!info) {
        return '';
      }
      return [info.name, info.partType].filter(Boolean).join(' • ');
    }

    const form = document.getElementById('aoi-form');
    const rejectionBody = document.getElementById('rejection-rows');
    const boardContainer = document.getElementById('board-rows');
    const addRejectionButton = document.getElementById('add-rejection');
    const addBoardButton = document.getElementById('add-board');
    const feedback = document.getElementById('form-feedback');
    const lotInspected = document.getElementById('lot-inspected');
    const lotRejected = document.getElementById('lot-rejected');
    const lotAccepted = document.getElementById('lot-accepted');
    const lotFeedback = document.getElementById('lot-feedback');
    const footerButtons = form.querySelectorAll('.aoi-footer-actions button');
    const problemPanel = document.querySelector('.aoi-problem-codes');

    let currentFormId = null;
    let autosaveTimer = null;
    let dirty = false;

    function computeAccepted() {
      const inspected = Number(lotInspected.value || 0);
      const rejected = Number(lotRejected.value || 0);
      if (rejected > inspected) {
        lotFeedback.textContent = 'Rejected cannot exceed inspected quantity.';
        lotRejected.classList.add('error');
      } else {
        lotFeedback.textContent = '';
        lotRejected.classList.remove('error');
      }
      lotAccepted.value = Math.max(inspected - rejected, 0);
    }

    function markDirty() {
      dirty = true;
    }

    function createRejectionRow() {
      const template = document.getElementById('rejection-row-template');
      const fragment = template.content.cloneNode(true);
      const row = fragment.querySelector('tr');
      const quantityInput = row.querySelector('.aoi-rejection-quantity');
      const codeSelect = row.querySelector('.aoi-rejection-code');
      const refInput = row.querySelector('.aoi-rejection-refdes');
      const nameCell = row.querySelector('.aoi-rejection-name');
      const deleteButton = row.querySelector('.aoi-delete-row');

      function updateName() {
        const details = formatProblemDetails(codeSelect.value);
        if (details) {
          nameCell.textContent = details;
        } else {
          nameCell.textContent = nameCell.dataset.placeholder || '';
        }
        codeSelect.title = details || '';
      }

      quantityInput.addEventListener('input', markDirty);
      codeSelect.addEventListener('change', () => {
        updateName();
        markDirty();
      });
      refInput.addEventListener('input', markDirty);
      deleteButton.addEventListener('click', () => {
        row.remove();
        markDirty();
      });

      updateName();
      rejectionBody.appendChild(row);
      return row;
    }

    function createBoardRow() {
      const template = document.getElementById('board-row-template');
      const fragment = template.content.cloneNode(true);
      const row = fragment.querySelector('.aoi-board-row');
      const deleteButton = row.querySelector('.aoi-delete-row');

      row.querySelectorAll('input, select').forEach((input) => {
        input.addEventListener('input', markDirty);
        input.addEventListener('change', markDirty);
      });

      deleteButton.addEventListener('click', () => {
        row.remove();
        markDirty();
      });

      boardContainer.appendChild(row);
      return row;
    }

    function collectRejections() {
      return Array.from(rejectionBody.querySelectorAll('tr')).map((row) => ({
        quantity: Number(row.querySelector('.aoi-rejection-quantity').value || 0),
        problem_code: row.querySelector('.aoi-rejection-code').value,
        reference_designators: row.querySelector('.aoi-rejection-refdes').value,
      }));
    }

    function collectBoardData() {
      return Array.from(boardContainer.querySelectorAll('.aoi-board-row')).map((row) => ({
        board_id: row.querySelector('.aoi-board-id').value,
        reference_designators: row.querySelector('.aoi-board-refdes').value,
        problem_code: row.querySelector('.aoi-board-code').value,
        comments: row.querySelector('.aoi-board-comments').value,
      }));
    }

    function collectPayload(status) {
      return {
        form_meta: {
          title: 'AOI Inspection Data Sheet',
          form_number: 'Form-114',
          form_rev: 'Rev. 17 (9/9/2025)',
        },
        header: {
          date: form.querySelector('[name="date"]').value,
          type: form.querySelector('[name="type"]:checked')?.value || null,
        },
        job: {
          customer: form.querySelector('[name="customer"]').value,
          assembly: form.querySelector('[name="assembly"]').value,
          job_number: form.querySelector('[name="job_number"]').value,
          revision: form.querySelector('[name="revision"]').value,
          panels_count: form.querySelector('[name="panels_count"]').value,
          boards_count: form.querySelector('[name="boards_count"]').value,
          inspector: form.querySelector('[name="inspector"]').value,
        },
        lot_result: {
          qty_inspected: lotInspected.value,
          qty_rejected: lotRejected.value,
        },
        rejections: collectRejections(),
        board_data: collectBoardData(),
        comments: form.querySelector('[name="comments"]').value,
        status,
      };
    }

    async function submitForm(status) {
      const payload = collectPayload(status);
      feedback.textContent = 'Saving…';
      try {
        const response = await fetch('{{ url_for("aoi.submit_form") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (!response.ok) {
          throw result;
        }

        feedback.textContent = result.message;
        dirty = false;
        currentFormId = result.form.id;
        form.dataset.formId = currentFormId;
        form.querySelector('[data-action="print"]').disabled = false;
        if (status === 'submitted' && result.redirect) {
          window.location.assign(result.redirect);
        }
        return result;
      } catch (error) {
        console.error(error);
        feedback.textContent = error.error ? JSON.stringify(error.error) : 'Save failed.';
        return null;
      }
    }

    function handleFooterClick(event) {
      const action = event.target.dataset.action;
      if (!action) return;

      if (action === 'print') {
        if (!currentFormId) {
          feedback.textContent = 'Save the form before printing or exporting.';
          return;
        }
        window.open(`{{ url_for('aoi.print_form', form_id='__ID__') }}`.replace('__ID__', currentFormId), '_blank');
        return;
      }

      submitForm(action === 'draft' ? 'draft' : 'submitted');
    }

    function setupAutosave() {
      if (autosaveTimer) {
        clearInterval(autosaveTimer);
      }
      autosaveTimer = setInterval(() => {
        if (!dirty) return;
        submitForm('draft');
      }, 15000);
    }

    function focusRowOnInsert(row) {
      const focusable = row.querySelector('input, select, textarea');
      if (focusable) {
        focusable.focus();
      }
    }

    addRejectionButton.addEventListener('click', () => {
      const row = createRejectionRow();
      focusRowOnInsert(row);
    });
    addBoardButton.addEventListener('click', () => {
      const row = createBoardRow();
      focusRowOnInsert(row);
    });
    footerButtons.forEach((button) => button.addEventListener('click', handleFooterClick));

    [lotInspected, lotRejected].forEach((input) => {
      input.addEventListener('input', () => {
        computeAccepted();
        markDirty();
      });
    });

    form.querySelectorAll('input, select, textarea').forEach((input) => {
      input.addEventListener('change', markDirty);
      input.addEventListener('input', markDirty);
    });

    problemPanel.addEventListener('click', (event) => {
      if (!(event.target instanceof HTMLButtonElement)) return;
      const code = event.target.dataset.problemCode;
      const activeRow = document.activeElement?.closest('tr');
      if (activeRow) {
        const select = activeRow.querySelector('.aoi-rejection-code');
        if (select) {
          select.value = code;
          select.dispatchEvent(new Event('change'));
          select.focus();
        }
      }
    });

    createRejectionRow();
    computeAccepted();
    setupAutosave();
  </script>
{% endblock %}
